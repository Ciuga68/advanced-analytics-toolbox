{"version":3,"sources":["analysis/decision_tree_predict.js"],"names":["define","tree","d3","utils","$q","createCube","app","$scope","layout","dimension","validateDimension","props","dimensions","qDef","qFieldDefs","meaLen","measures","length","params","validateMeasure","meaList","dataType","paramNames","measureLabels","label","i","mea","param","push","splitData","splitDataset","training","splitPercentageForDecisionTree","test","predictType","MAE","rpartMethod","minSplit","minBucket","cp","maxDepth","qLabel","backendApi","applyPatches","qPath","qOp","qValue","JSON","stringify","patchApplied","drawChart","defer","requestPage","qTop","qLeft","qWidth","qHeight","getData","then","dataPages","qMatrix","qText","displayConnectionError","extId","result","parse","rowLabels","columnLabels","data","numOfRows","roundWithDecimals","n","decimals","Math","round","pow","html","accuracyDenominator","accuracyNumerator","precisions","recallDenominator","recallNumerator","recalls","j","precisionDenominator","precisionNumerator","sum","arr","reduce","prev","current","average","fn","$","resolve","promise"],"mappings":"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","file":"../../js/analysis/decision_tree_predict.js","sourcesContent":["define([\r\n  '../chart/tree_chart',\r\n  '../../vendor/d3.min',\r\n  '../util/utils',\r\n  'ng!$q',\r\n], (tree, d3, utils, $q) => {\r\n  return {\r\n    /**\r\n     * createCube - create HyperCubes\r\n     *\r\n     * @param {Object} app    reference to app\r\n     * @param {Object} $scope angular $scope\r\n     *\r\n     * @return {Null} null\r\n     */\r\n    createCube(app, $scope) {\r\n      const layout = $scope.layout;\r\n\r\n      // Display loader\r\n      // utils.displayLoader($scope.extId);\r\n\r\n      const dimension = utils.validateDimension(layout.props.dimensions[0]);\r\n\r\n      // Set definitions for dimensions and measures\r\n      const dimensions = [{ qDef: { qFieldDefs: [dimension] } }];\r\n\r\n      const meaLen = layout.props.measures.length;\r\n      let params = `${utils.validateMeasure(layout.props.measures[0])} as mea0, ${utils.validateMeasure(layout.props.measures[1])} as mea1`;\r\n      let meaList = 'mea0 ~ mea1';\r\n      let dataType = 'SS';\r\n\r\n      // Array to replace param names (q$meaX) to a measure label on tree chart\r\n      $scope.paramNames = ['mea0', 'mea1'];\r\n      $scope.measureLabels = [layout.props.measures[0].label, layout.props.measures[1].label];\r\n\r\n      for (let i = 2; i < meaLen; i++) {\r\n        const mea = utils.validateMeasure(layout.props.measures[i]);\r\n        if (mea.length > 0) {\r\n          const param = `,${mea} as mea${i}`;\r\n          params += param;\r\n          meaList += ` + mea${i}`;\r\n          dataType += 'S';\r\n\r\n          $scope.paramNames.push(`mea${i}`);\r\n          $scope.measureLabels.push(layout.props.measures[i].label);\r\n        }\r\n      }\r\n\r\n      // Split dataset into training and test datasets\r\n      let splitData = 'training_data<-q;';\r\n      if (layout.props.splitDataset) {\r\n        let training = `splitPercentage<-min(max(0.01, ${layout.props.splitPercentageForDecisionTree}), 0.99); data_end<-length(q$mea0); data_mid<-floor(data_end * splitPercentage); training_data<-list(mea0=q$mea0[1:data_mid]`;\r\n        let test = 'test_data<-list(mea0=q$mea0[(data_mid + 1):data_end]';\r\n        for (let i = 1; i < meaLen; i++) {\r\n          training += `,mea${i}=q$mea${i}[1:data_mid]`;\r\n          test += `,mea${i}=q$mea${i}[(data_mid + 1):data_end]`\r\n        }\r\n        training += ');';\r\n        test += ');';\r\n        splitData = training + test;\r\n      }\r\n\r\n      // type in predict method for regression tree is 'vector' not 'anova'\r\n      let predictType = 'class';\r\n      let MAE = ''; // Calculate mean absolute error for regression tree\r\n      if (layout.props.rpartMethod === 'anova') {\r\n        predictType = 'vector';\r\n        MAE = ',mean(abs(test_data$mea0-pred))'\r\n      }\r\n\r\n      const measures = [\r\n        {\r\n          qDef: {\r\n            qDef: `R.ScriptEvalExStr('${dataType}','library(rpart);library(jsonlite);set.seed(10);\r\n                    q<-lapply(q, function(x){ ifelse(!is.na(as.numeric(x)), as.numeric(x), x) }); ${splitData}\r\n                    res<-rpart(${meaList}, data=training_data, method=\"${layout.props.rpartMethod}\", control=list(minsplit=${layout.props.minSplit}, minbucket=${layout.props.minBucket}, cp=${layout.props.cp}, maxdepth=${layout.props.maxDepth}));\r\n                    pred <- predict(res, test_data, type=\"${predictType}\"); conf.mat <- table(pred, test_data$mea0);\r\n                    json<-toJSON(list(list(attributes(conf.mat)$dimnames[[1]], attributes(conf.mat)$dimnames[[2]]), unname(split(conf.mat, seq(nrow(conf.mat)))), c(length(training_data$mea0), length(test_data$mea0))${MAE})); json;',${params})`,\r\n          },\r\n        },\r\n        {\r\n          qDef: {\r\n            qLabel: '-',\r\n            qDef: '', // Dummy\r\n          },\r\n        },\r\n        {\r\n          qDef: {\r\n            qLabel: '-',\r\n            qDef: '', // Dummy\r\n          },\r\n        },\r\n        {\r\n          qDef: {\r\n            qLabel: '-',\r\n            qDef: '', // Dummy\r\n          },\r\n        },\r\n        {\r\n          qDef: {\r\n            qLabel: '-',\r\n            qDef: '', // Dummy\r\n          },\r\n        },\r\n      ];\r\n\r\n      $scope.backendApi.applyPatches([\r\n        {\r\n          qPath: '/qHyperCubeDef/qDimensions',\r\n          qOp: 'replace',\r\n          qValue: JSON.stringify(dimensions),\r\n        },\r\n        {\r\n          qPath: '/qHyperCubeDef/qMeasures',\r\n          qOp: 'replace',\r\n          qValue: JSON.stringify(measures),\r\n        },\r\n      ], false);\r\n\r\n      $scope.patchApplied = true;\r\n      return null;\r\n    },\r\n    /**\r\n     * drawChart - draw chart with updated data\r\n     *\r\n     * @param {Object} $scope angular $scope\r\n     *\r\n     * @return {Object} Promise object\r\n     */\r\n    drawChart($scope, app) {\r\n      const defer = $q.defer();\r\n      const layout = $scope.layout;\r\n      const requestPage = [{\r\n        qTop: 0,\r\n        qLeft: 0,\r\n        qWidth: 6,\r\n        qHeight: 1,\r\n      }];\r\n\r\n      $scope.backendApi.getData(requestPage).then((dataPages) => {\r\n        // Display error when all measures' grand total return NaN.\r\n        if (dataPages[0].qMatrix[0][1].qText.length === 0 || dataPages[0].qMatrix[0][1].qText == '-') {\r\n          utils.displayConnectionError($scope.extId);\r\n        } else {\r\n          const result = JSON.parse(dataPages[0].qMatrix[0][1].qText);\r\n\r\n          const rowLabels = result[0][0];\r\n          const columnLabels = result[0][1];\r\n          const data = result[1];\r\n          const numOfRows = result[2];\r\n\r\n          // Helper to round Number\r\n          const roundWithDecimals = (n, decimals) => {\r\n            return Math.round(n * Math.pow(10, decimals)) / Math.pow(10, decimals);\r\n          };\r\n\r\n          // Set table header for cunfusion matrix\r\n          let html = `\r\n            <h2>Confusion matrix:</h2>\r\n            <table class=\"simple\" >\r\n              <thead>\r\n                <tr>\r\n                  <th rowspan=\"2\" style=\"border-right:none;\"></th><th rowspan=\"2\"></th><th colspan=\"${columnLabels.length + 1}\" style=\"text-align:center\">Actual class</th>\r\n                </tr>\r\n                <tr>\r\n                  `;\r\n\r\n          for (let i = 0; i < columnLabels.length; i++) {\r\n            html += `<th>${columnLabels[i]}</th>`;\r\n          }\r\n\r\n          html += `<th>Precision</th></tr>\r\n            </thead>\r\n            <tbody>`;\r\n\r\n          // Set table body for cunfusion matrix\r\n          let accuracyDenominator = 0;\r\n          let accuracyNumerator = 0;\r\n          const precisions = [];\r\n          const recallDenominator = [];\r\n          const recallNumerator = [];\r\n          const recalls = [];\r\n\r\n          // Initialize recallDenominator and recallNumerator with zeros\r\n          for (let j = 0; j < columnLabels.length; j++) {\r\n            recallDenominator[j] = 0;\r\n            recallNumerator[j] = 0;\r\n          }\r\n\r\n          // Repeat evey row\r\n          for (let i = 0; i < rowLabels.length; i++) {\r\n            if (i === 0) {\r\n              html += `<tr><td rowspan=\"${rowLabels.length + 1}\" style=\"font-weight:bold; white-space:nowrap; width:20px\">Predicted class</td><td style=\"font-weight:bold\">${rowLabels[i]}</td>`;\r\n            } else {\r\n              html += `<tr><td style=\"font-weight:bold\">${rowLabels[i]}</td>`;\r\n            }\r\n\r\n            let precisionDenominator = 0;\r\n            let precisionNumerator = 0;\r\n            // Repease evey column\r\n            for (let j = 0; j < columnLabels.length; j++) {\r\n              accuracyNumerator += data[i][j];\r\n              precisionNumerator += data[i][j];\r\n              recallNumerator[j] += data[i][j];\r\n              if (i === j) {\r\n                accuracyDenominator += data[i][j];\r\n                precisionDenominator += data[i][j];\r\n                recallDenominator[j] += data[i][j];\r\n              }\r\n              html += `<td>${data[i][j]}</td>`;\r\n            }\r\n            precisions.push(precisionDenominator / precisionNumerator);\r\n            // Set precisions\r\n            if (layout.props.rpartMethod === 'class') {\r\n              html += `<td>${roundWithDecimals((precisionDenominator / precisionNumerator) * 100, 3)}%</td></tr>`;\r\n            } else {\r\n              html += '<td>-</td></tr>';\r\n            }\r\n          }\r\n\r\n          // Set recalls\r\n          html += '<tr><td style=\"font-weight:bold;\">Recall</td>';\r\n          for (let j = 0; j < recallDenominator.length; j++) {\r\n            if (layout.props.rpartMethod === 'class') {\r\n              html += `<td>${roundWithDecimals((recallDenominator[j] / recallNumerator[j]) * 100, 3)}%</td>`;\r\n            } else {\r\n              html += '<td>-</td>';\r\n            }\r\n            recalls.push(recallDenominator[j] / recallNumerator[j]);\r\n          }\r\n          html += '<td></td></tr>';\r\n\r\n          html += `</tbody>\r\n                  </table>`;\r\n\r\n          // Helpers for calculating performance measures\r\n          const sum = (arr) => {\r\n            return arr.reduce((prev, current, i, arr) => {\r\n              return prev + current;\r\n            });\r\n          };\r\n\r\n          const average = (arr, fn) => {\r\n            return sum(arr, fn) / arr.length;\r\n          };\r\n\r\n        if (layout.props.rpartMethod === 'anova') {\r\n          // Set performance measures\r\n          html += `<h2>Performance measures:</h2>\r\n                  <table class=\"simple\" style=\"table-layout:fixed;\">\r\n                    <thead>\r\n                      <tr>\r\n                        <th>Measures</th><th>Results</th>\r\n                      </tr>\r\n                    </thead>\r\n                    <tbody>\r\n                      <tr><td>Mean absolute error (MAE)</td><td>${result[3]}</td></tr>\r\n                    </tbody>\r\n                  </table>\r\n                `;\r\n\r\n        } else {\r\n          // Set performance measures\r\n          html += `<h2>Performance measures:</h2>\r\n                  <table class=\"simple\" style=\"table-layout:fixed;\">\r\n                    <thead>\r\n                      <tr>\r\n                        <th>Measures</th><th>Results</th>\r\n                      </tr>\r\n                    </thead>\r\n                    <tbody>\r\n                      <tr><td>Accuracy</td><td>${(layout.props.rpartMethod === 'class') ? roundWithDecimals((accuracyDenominator / accuracyNumerator) * 100, 3) + '%' : '-'}</td></tr>\r\n                      <tr><td>Average precision</td><td>${(layout.props.rpartMethod === 'class') ? roundWithDecimals((average(precisions) * 100), 3) + '%' : '-'}</td></tr>\r\n                      <tr><td>Average recall</td><td>${(layout.props.rpartMethod === 'class') ? roundWithDecimals(average(recalls) * 100, 3) + '%' : '-'}</td></tr>\r\n                    </tbody>\r\n                  </table>\r\n                `;\r\n          }\r\n\r\n\r\n          // Set number of rows\r\n          html += `<h2>Number of rows:</h2>\r\n                  <table class=\"simple\" style=\"table-layout:fixed;\">\r\n                    <thead>\r\n                      <tr>\r\n                        <th>Datasets</th><th>Number of rows</th>\r\n                      </tr>\r\n                    </thead>\r\n                    <tbody>\r\n                      <tr><td>Training data</td><td>${numOfRows[0]}</td></tr>\r\n                      <tr><td>Test data</td><td>${numOfRows[1]}</td></tr>\r\n                      <tr><td>Total</td><td>${numOfRows[0] + numOfRows[1]}</td></tr>\r\n                    </tbody>\r\n                  </table>\r\n                `;\r\n\r\n          // Set HTML element for chart\r\n          $(`.advanced-analytics-toolsets-${$scope.extId}`).html(html);\r\n        }\r\n        return defer.resolve();\r\n      });\r\n      return defer.promise;\r\n    },\r\n  };\r\n});\r\n"]}