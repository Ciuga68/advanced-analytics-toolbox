"use strict";define(["../chart/line_chart","../chart/datatables","../util/utils","ng!$q","../../vendor/d3-format.min"],function(e,t,a,r,o){return{createCube:function(e,t){var r=t.layout,o=a.validateDimension(r.props.dimensions[0]),s=[{qNullSuppression:!0,qDef:{qFieldDefs:[o],qSortCriterias:[{qSortByNumeric:1}]}}],l=a.validateMeasure(r.props.measures[0]),i="";r.props.frequency>0&&(i=",frequency="+r.props.frequency);var p="";r.props.autoHoltWinters||(p=",alpha="+r.props.holtWintersAlpha+",beta="+r.props.holtWintersBeta+",gamma="+r.props.holtWintersGamma),a.displayDebugModeMessage(r.props.debugMode);var n=a.getDebugSaveDatasetScript(r.props.debugMode,"debug_holt_winters.rda"),d="R.ScriptEvalExStr('N', '"+n+" library(jsonlite);library(dplyr);library(forecast);data<-ts(na.omit(q$Measure) "+i+');\n      fit<-HoltWinters(data, seasonal="'+r.props.seasonal+'" '+p+");\n      res<-forecast(fit, level="+r.props.confidenceLevel+", h="+r.props.forecastingPeriods+");\n      json<-toJSON(list(as.double(res$mean),as.double(res$upper),as.double(res$lower),list(fit$alpha, fit$beta, fit$gamma, fit$coefficients))); json;', "+l+" as Measure)";a.displayRScriptsToConsole(r.props.debugMode,[d]);var u=[{qDef:{qDef:l}},{qDef:{qDef:d}},{qDef:{qLabel:"-",qDef:""}},{qDef:{qLabel:"-",qDef:""}},{qDef:{qLabel:"-",qDef:""}}];return t.backendApi.applyPatches([{qPath:"/qHyperCubeDef/qDimensions",qOp:"replace",qValue:JSON.stringify(s)},{qPath:"/qHyperCubeDef/qMeasures",qOp:"replace",qValue:JSON.stringify(u)}],!1),t.patchApplied=!0,null},drawChart:function(o,s){var l=r.defer(),i=o.layout,p=[{qTop:0,qLeft:0,qWidth:6,qHeight:1500}];return o.backendApi.getData(p).then(function(r){var p=null,n=r[0].qMatrix;if(0===n[0][2].qText.length||"-"==n[0][2].qText)for(var d=0;d<n.length;d++)0!==n[d][2].qText.length&&"-"!==n[d][2].qText&&(p=JSON.parse(n[d][2].qText));else p=JSON.parse(n[0][2].qText);if(null==p)a.displayConnectionError(o.extId);else{a.displayReturnedDatasetToConsole(i.props.debugMode,r[0]);var u=a.getDefaultPaletteColor(),h=p[0],m=p[1],c=p[2],f=p[3],b=f[0],q=f[1],y=f[2];if("undefined"==typeof o.layout.props.displayTable||0==o.layout.props.displayTable){var g={},x=r[0].qMatrix.length,v=[],D=[],M=[];$.each(r[0].qMatrix,function(e,t){v.push(t[0].qElemNumber),D.push(t[0].qText),M.push(t[1].qNum)}),g.elemNum=v,g.dim1=D,g.mea1=M;for(var N=new Array(x),S=new Array(x),w=new Array(x),T=0;T<i.props.forecastingPeriods;T++)g.dim1.push("+"+(T+1)),N.push(h[T]),S.push(m[T]),w.push(c[T]);g.mea2=N,g.mea3=S,g.mea4=w;var A=[{x:g.dim1,y:g.mea1,elemNum:g.elemNum,name:"Observed",mode:"lines+markers",fill:i.props.line,fillcolor:i.props.colors?"rgba("+u[3]+",0.3)":"rgba("+u[i.props.colorForMain]+",0.3)",marker:{color:i.props.colors?"rgba("+u[3]+",1)":"rgba("+u[i.props.colorForMain]+",1)",size:i.props.datapoints?i.props.pointRadius:1},line:{width:i.props.borderWidth}},{x:g.dim1,y:g.mea2,name:"Fit",mode:"lines+markers",marker:{color:i.props.colors?"rgba("+u[7]+",1)":"rgba("+u[i.props.colorForSub]+",1)",size:i.props.datapoints?i.props.pointRadius:1},line:{width:i.props.borderWidth}},{x:g.dim1,y:g.mea3,name:"Upper",fill:"tonexty",fillcolor:"rgba("+u[i.props.colorForSub]+",0.3)",type:"scatter",mode:"none"},{x:g.dim1,y:g.mea4,name:"Lower",fill:"tonexty",fillcolor:"rgba("+u[i.props.colorForSub]+",0.3)",type:"scatter",mode:"none"}],C={xaxis:{type:"category",title:o.layout.props.xLabelsAndTitle?o.layout.props.dimensions[0].label:"",showgrid:o.layout.props.xScale,side:o.layout.props.xAxisPosition}};i.props.displayHoltWintersParams?$(".advanced-analytics-toolsets-"+o.extId).html('\n                <div style="width:100%;height:5%;text-align:right;">alpha='+b+", beta="+q+", gamma="+y+'</div>\n                <div id="aat-chart-'+o.extId+'" style="width:100%;height:95%;"></div>\n              '):$(".advanced-analytics-toolsets-"+o.extId).html('<div id="aat-chart-'+o.extId+'" style="width:100%;height:100%;"></div>');var F=e.draw(o,A,"aat-chart-"+o.extId,C);e.setEvents(F,o,s)}else{var L=a.getLocale(o,0),P=a.getNumberFormat(o,0),W=(r[0].qMatrix.length,[]);$.each(r[0].qMatrix,function(e,t){W.push([t[0].qElemNumber,t[0].qText,L.format(P)(t[1].qNum).replace(/G/,"B"),"","",""])});for(var E=0;E<i.props.forecastingPeriods;E++)W.push(["","+"+(E+1),"",L.format(P)(h[E]).replace(/G/,"B"),L.format(P)(m[E]).replace(/G/,"B"),L.format(P)(c[E]).replace(/G/,"B")]);var I='\n              <table id="aat-table-'+o.extId+'" class="display">\n                <thead>\n                  <tr>\n                    <th>qElemNumber</th>\n                    <th>'+o.layout.props.dimensions[0].label+"</th>\n                    <th>"+o.layout.props.measures[0].label+"</th>\n                    <th>Fit</th>\n                    <th>Lower</th>\n                    <th>Upper</th>\n                  </tr>\n                </thead>\n                <tbody>\n                </tbody>\n              </table>";t.draw(s,o,"#aat-table-"+o.extId,W,I,null).then(function(e){t.setEvents(e,o,s)})}}return l.resolve()}),l.promise}}});
//# sourceMappingURL=../../maps/analysis/holt_winters.js.map
